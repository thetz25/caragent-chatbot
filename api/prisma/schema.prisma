generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CarModel {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  segment     String?      // e.g., "MPV", "SUV"
  description String?
  year        Int?
  variants    CarVariant[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("car_models")
}

model CarVariant {
  id           Int        @id @default(autoincrement())
  modelId      Int
  name         String     // e.g., "GLS Sport", "Black Series"
  srp          Decimal    @db.Decimal(12, 2)
  transmission String?    // "A/T", "M/T"
  fuel         String?    // "Gasoline", "Diesel"
  specs        Json?      // Flexible key-value storage for specs
  model        CarModel   @relation(fields: [modelId], references: [id])
  media        CarMedia[]
  quotes       Quote[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("car_variants")
}

model CarMedia {
  id        Int         @id @default(autoincrement())
  variantId Int?
  modelId   Int?        // Optional: for generic model photos
  url       String
  type      MediaType   @default(IMAGE) // IMAGE, PDF, VIDEO
  label     String?     // e.g., "Front View", "Brochure"
  variant   CarVariant? @relation(fields: [variantId], references: [id])
  createdAt DateTime    @default(now())

  @@map("car_media")
}

model PriceRule {
  id          Int      @id @default(autoincrement())
  region      String   @default("NCR")
  fees        Json?    // { registration: 5000, chattel: 15000 }
  promos      Json?    // { discount: 10000, freebies: ["Tint", "Matting"] }
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("price_rules")
}

model Quote {
  id        String   @id @default(uuid())
  userId    String   // PSID from Messenger
  variantId Int
  variant   CarVariant @relation(fields: [variantId], references: [id])
  details   Json     // Snapshot of calculation: { srp: 100, dp: 20, monthly: 5 }
  status    String   @default("GENERATED") // GENERATED, SENT, ACCEPTED
  createdAt DateTime @default(now())

  @@map("quotes")
}

model Session {
  id        String   @id // PSID
  state     Json?    // { currentStep: "ASK_BUDGET", context: {} }
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("sessions")
}

model FAQ {
  id        Int      @id @default(autoincrement())
  question  String   @unique
  answer    String
  category  String   // e.g., "Warranty", "Financing", "Maintenance"
  keywords  String[] // For search matching
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("faqs")
  @@index([category])
}

enum MediaType {
  IMAGE
  PDF
  VIDEO
}
